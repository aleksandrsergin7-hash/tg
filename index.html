<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —à—Ç—É–∫–∏, –†–î–°</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --primary: #3498db; --primary-hover: #2980b9; --active: #2ecc71;
            --text: #333; --bg: #f5f7fa; --container-bg: white; --border: #e1e8ed;
            --error: #e74c3c; --error-bg: #fdf2f2; --success: #27ae60;
            --shadow: rgba(0,0,0,0.08); --table-header: #f8fafc; --table-even: #f9fafb;
            --total-row: #f0f9ff; --telegram-bg: #0088cc; --telegram-hover: #0077b3;
        }
        [data-theme="dark"] {
            --text: #ecf0f1; --bg: #1a1a1a; --container-bg: #2d3436; --border: #4b6584;
            --error-bg: #2c1a1a; --shadow: rgba(0,0,0,0.3); --table-header: #34495e;
            --table-even: #2c3e50; --total-row: #1e3799;
        }
        body { font-family: 'Montserrat', Arial, sans-serif; margin: 0; padding: 16px; background: var(--bg); color: var(--text); transition: all 0.3s ease; }
        .container { max-width: 900px; margin: 0 auto; background: var(--container-bg); border-radius: 16px; padding: 20px; box-shadow: 0 8px 30px var(--shadow); transition: all 0.3s ease; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { font-weight: 600; font-size: 22px; margin: 0; }
        .theme-toggle, .telegram-close { background: var(--primary); color: white; border: none; border-radius: 20px; padding: 8px 16px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .theme-toggle:hover, .telegram-close:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .telegram-close { background: #e74c3c; display: none; }
        .telegram-close:hover { background: #c0392b; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 20px; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        input, select { width: 100%; padding: 12px; margin-top: 4px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; background: var(--container-bg); color: var(--text); transition: 0.3s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(52,152,219,0.2); }
        .button-group { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
        button { flex: 1; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; padding: 14px; min-height: 50px; transition: 0.3s; opacity: 1; min-width: 120px; }
        button:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-1px); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; opacity: 0.6; }
        button.active { background: var(--active); }
        .checkbox-group { margin-top: 12px; }
        .checkbox-group label { display: flex; align-items: center; font-weight: normal; cursor: pointer; }
        .checkbox-group input { width: auto; margin-right: 8px; }
        .spinner { width: 40px; height: 40px; margin: 0 auto; border: 4px solid rgba(52,152,219,0.3); border-left: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { text-align: center; margin: 10px 0; font-weight: 600; color: var(--primary); font-size: 16px; display: none; }
        .progress-bar { width: 100%; height: 4px; background: rgba(52,152,219,0.3); border-radius: 2px; margin: 10px auto; overflow: hidden; display: none; }
        .progress { width: 0%; height: 100%; background: var(--primary); border-radius: 2px; transition: width 0.4s ease; }
        .error { color: var(--text); text-align: center; margin: 16px 0; font-weight: 600; font-size: 14px; padding: 12px; background: var(--error-bg); border-radius: 8px; border: 1px solid var(--error); opacity: 0.9; line-height: 1.5; }
        .telegram-tag { background: var(--telegram-bg); color: white; padding: 4px 8px; border-radius: 6px; cursor: pointer; margin: 0 2px; font-weight: 600; transition: all 0.3s ease; display: inline-block; border: 1px solid transparent; }
        .telegram-tag:hover { background: var(--telegram-hover); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .copy-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s ease; }
        .copy-notification.show { opacity: 1; }
        .results { margin-top: 25px; display: none; opacity: 0; transition: opacity 0.5s ease; }
        .results.show { opacity: 1; display: block; }
        .table-wrapper { overflow-x: auto; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow); margin-top: 16px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; background: var(--container-bg); min-width: 500px; }
        th, td { border: 1px solid var(--border); padding: 12px 10px; text-align: center; font-size: 13px; }
        th { background: var(--table-header); font-weight: 600; font-size: 12px; color: var(--text); text-transform: uppercase; }
        tr:nth-child(even) { background-color: var(--table-even); }
        .total-row { font-weight: bold; background-color: var(--total-row) !important; color: var(--primary); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--container-bg); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px var(--shadow); }
        .close { color: #aaa; float: right; font-size: 24px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close:hover { color: var(--text); }
        .section { display: none; margin-top: 20px; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .section.active { display: block; opacity: 1; transform: translateY(0); }
        .loading { display: none; }
        .loading .spinner, .loading .loading-text, .loading .progress-bar { display: block; }
        @media (max-width: 768px) {
            .container { padding: 15px; } h1 { font-size: 20px; } .button-group { flex-direction: column; }
            button { min-height: 45px; } .modal-content { width: 95%; padding: 20px; }
            th, td { padding: 10px 8px; font-size: 12px; } .header { flex-direction: column; gap: 10px; }
        }
        @media (max-width: 480px) {
            body { padding: 10px; } .container { padding: 12px; border-radius: 12px; } h1 { font-size: 18px; }
            .subtitle { font-size: 13px; } input, select { padding: 10px; font-size: 14px; }
            button { padding: 12px; font-size: 14px; } th, td { padding: 8px 6px; font-size: 11px; }
        }
        .telegram-mode .theme-toggle { display: none; }
        .telegram-mode .header { padding-top: 10px; }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <div class="header">
            <h1>‚è±Ô∏è –°–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —à—Ç—É–∫–∏, –†–î–°</h1>
            <button class="theme-toggle" onclick="toggleTheme()">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
            <button class="telegram-close" onclick="closeWebApp()" style="display:none;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        
        <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞</p>

        <div class="form-group">
            <label for="phone">üì± –¢–µ–ª–µ—Ñ–æ–Ω / ID LO</label>
            <input type="text" id="phone" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 79123456789">
        </div>

        <div class="button-group">
            <button id="rdsBtn" class="active" onclick="openRDS()">üìä –†–î–°</button>
            <button id="picksBtn" onclick="openPicks()">üì¶ –®–¢–£–ö–ò</button>
            <button id="hoursBtn" onclick="openHours()">‚è∞ –ß–ê–°–´</button>
            <button onclick="showInstructions()">‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
        </div>

        <div id="rdsSection" class="section active">
            <label>üìÖ –î–∞—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:</label>
            <input type="date" id="rdsDate">
            <div class="checkbox-group">
                <label><input type="checkbox" id="rdsFullInfo"> –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
            </div>
            <div class="button-group" style="margin-top:10px;">
                <button onclick="searchRDSByDate()">–ü–æ –¥–Ω—é</button>
                <button onclick="searchRDSCurrentMonth()">–ó–∞ –º–µ—Å—è—Ü</button>
            </div>
        </div>

        <div id="picksSection" class="section">
            <div class="button-group">
                <button onclick="showPicksDay()">–î–µ–Ω—å</button>
                <button onclick="showPicksWeek()">–ù–µ–¥–µ–ª—è</button>
                <button onclick="searchPicksCurrentMonth()">–ú–µ—Å—è—Ü</button>
            </div>
            
            <div id="picksDaySection" class="section active" style="margin-top:10px;">
                <input type="date" id="picksDayDate">
                <button onclick="searchPicksByDay()">–ü–æ –¥–Ω—é</button>
            </div>
            
            <div id="picksWeekSection" class="section" style="margin-top:10px;">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é:</label>
                <select id="weekSelect">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é --</option>
                </select>
                <button onclick="searchPicksByWeek()" style="margin-top:10px;">–ü–æ–∏—Å–∫ –∑–∞ –Ω–µ–¥–µ–ª—é</button>
            </div>
        </div>

        <div id="hoursSection" class="section">
            <label>üìÖ –î–∞—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:</label>
            <input type="date" id="hoursDate">
            <div class="button-group" style="margin-top:10px;">
                <button onclick="searchHoursByDate()">–ü–æ –¥–Ω—é</button>
                <button onclick="searchHoursCurrentMonth()">–ó–∞ –º–µ—Å—è—Ü</button>
            </div>
        </div>

        <div id="loading" style="display:none;">
            <div class="spinner"></div>
            <div class="loading-text">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
        </div>

        <div id="error"></div>

        <div id="results">
            <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInstructions()">&times;</span>
            <h3>‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</h3>
            <ul>
                <li>–í–≤–æ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ ID LO –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ</li>
                <li><strong>–†–î–°</strong>: –ø–æ–∏—Å–∫ –ø–æ ID, —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–ª–∏ –∫—Ä–∞—Ç–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</li>
                <li><strong>–®–¢–£–ö–ò</strong>: –ø–æ–∏—Å–∫ –ø–æ ID –∏ –¥–∞—Ç–µ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –¥–Ω—è–º, –Ω–µ–¥–µ–ª—è–º –∏–ª–∏ –º–µ—Å—è—Ü–∞–º</li>
                <li><strong>–ß–ê–°–´</strong>: –ø–æ–∏—Å–∫ –ø–æ ID —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã, –±–æ–Ω—É—Å–æ–≤ –∏ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –ø–æ–∏—Å–∫–∞</li>
            </ul>
        </div>
    </div>

    <div id="copyNotification" class="copy-notification">‚úÖ –¢–µ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzPK14g2ZpYn6KJ_GYBdvt8yw6nR3YZz5MCkQEyxVuaZdnc9Wy2B0T3aRjDLVolRb2e/exec';
        let currentSection = 'rds', searchTimeout = null;

        // Telegram Web App
        function initTelegramWebApp() {
            if (window.Telegram?.WebApp) {
                const tg = Telegram.WebApp;
                document.body.classList.add('telegram-mode');
                document.querySelector('.telegram-close').style.display = 'block';
                tg.expand();
                if (tg.colorScheme === 'dark') document.body.setAttribute('data-theme', 'dark');
                const user = tg.initDataUnsafe?.user;
                if (user?.phone_number) document.getElementById('phone').value = user.phone_number;
                tg.BackButton.onClick(() => tg.close());
                tg.BackButton.show();
            }
        }

        function closeWebApp() { window.Telegram?.WebApp?.close(); }

        // Theme management
        function toggleTheme() {
            const body = document.body, currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        }

        // Copy functionality
        function copyToClipboard(text) {
            if (navigator.clipboard?.writeText) {
                navigator.clipboard.writeText(text).then(() => showCopyNotification()).catch(() => copyFallback(text));
            } else copyFallback(text);
        }

        function copyFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text; textArea.style.cssText = 'position:fixed;left:-999999px;top:-999999px';
            document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try { document.execCommand('copy'); showCopyNotification(); } catch { alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + text); }
            document.body.removeChild(textArea);
        }

        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 2000);
        }

        // Section management
        function setActiveButton(buttonId) {
            ['rdsBtn','picksBtn','hoursBtn'].forEach(id => document.getElementById(id).classList.remove('active'));
            document.getElementById(buttonId).classList.add('active');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            setTimeout(() => document.getElementById(sectionId).classList.add('active'), 50);
        }

        function openRDS() { currentSection = 'rds'; setActiveButton('rdsBtn'); showSection('rdsSection'); clearForm(); }
        function openPicks() { currentSection = 'picks'; setActiveButton('picksBtn'); showSection('picksSection'); showPicksDay(); clearForm(); }
        function openHours() { currentSection = 'hours'; setActiveButton('hoursBtn'); showSection('hoursSection'); clearForm(); }

        function clearForm() {
            document.getElementById('error').textContent = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('tableBody').innerHTML = '';
        }

        // Picks management
        function showPicksDay() {
            document.getElementById('picksDaySection').classList.add('active');
            document.getElementById('picksWeekSection').classList.remove('active');
        }

        function showPicksWeek() {
            document.getElementById('picksDaySection').classList.remove('active');
            document.getElementById('picksWeekSection').classList.add('active');
            generateWeekOptions();
        }

        function generateWeekOptions() {
            const select = document.getElementById('weekSelect');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é --</option>';
            const today = new Date(), start = new Date(today);
            start.setDate(today.getDate() - today.getDay() + 1);
            for(let i = -4; i <= 1; i++) {
                const weekStart = new Date(start); weekStart.setDate(start.getDate() + i * 7);
                const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6);
                const option = document.createElement('option');
                option.value = `${weekStart.toISOString().split('T')[0]}_${weekEnd.toISOString().split('T')[0]}`;
                option.textContent = `${formatDDMMYY(weekStart)} ‚Äî ${formatDDMMYY(weekEnd)}`;
                select.appendChild(option);
            }
        }

        function formatDDMMYY(d) {
            return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getFullYear()).slice(-2)}`;
        }

        // Loading states
        function showLoading() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            document.querySelector('.loading-text').style.display = 'block';
            document.querySelector('.spinner').style.display = 'block';
            document.querySelector('.progress-bar').style.display = 'block';
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 90) clearInterval(interval);
                else { width += Math.random() * 10; document.querySelector('.progress').style.width = Math.min(width, 90) + '%'; }
            }, 200);
            return interval;
        }

        function hideLoading(interval) {
            clearInterval(interval);
            document.querySelector('.progress').style.width = '100%';
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.loading-text').style.display = 'none';
                document.querySelector('.spinner').style.display = 'none';
                document.querySelector('.progress-bar').style.display = 'none';
                document.querySelector('.progress').style.width = '0%';
            }, 500);
        }

        // Error handling
        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showManagerMessage(message) {
            const error = document.getElementById('error');
            
            let htmlMessage = '';
            const lines = message.split('\n');
            
            lines.forEach(line => {
                let processedLine = line;
                
                // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º (—Ñ–æ—Ä–º–∞—Ç: "üìû –í–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä: –ò–º—è –§–∞–º–∏–ª–∏—è")
                const managerMatch = line.match(/üìû –í–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä:\s*(.+)/);
                if (managerMatch) {
                    const managerName = managerMatch[1].trim();
                    processedLine = `<strong>${line}</strong>`;
                }
                
                // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å Telegram —Ç–µ–≥–æ–º (—Ñ–æ—Ä–º–∞—Ç: "üí¨ Telegram: @username")
                const telegramMatch = line.match(/üí¨ Telegram:\s*(@[\w_]+)/);
                if (telegramMatch) {
                    const telegramTag = telegramMatch[1];
                    processedLine = line.replace(
                        telegramTag, 
                        `<span class="telegram-tag" onclick="copyToClipboard('${telegramTag}')" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                            ${telegramTag} üìã
                        </span>`
                    );
                }
                
                htmlMessage += processedLine + '<br>';
            });
            
            error.innerHTML = htmlMessage;
            error.style.display = 'block';
        }

        // Search functionality
        document.getElementById('phone').addEventListener('input', () => clearTimeout(searchTimeout));

        function performSearch(phone, date, month, type, fullInfo, endDate = null) {
            console.log('üîç –ü–æ–∏—Å–∫:', { phone, date, month, type, fullInfo, endDate });
            
            if(!phone) return showError('‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä/ID');
            if(!type) return showError('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞');
            
            hideError();
            const buttons = document.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);
            
            const progressInterval = showLoading();
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                const params = new URLSearchParams();
                params.append('phone', phone);
                params.append('type', type);
                params.append('fullInfo', fullInfo);
                if (date) params.append('date', date);
                if (month) params.append('month', month);
                if (endDate) params.append('endDate', endDate);
                
                // JSONP –∑–∞–ø—Ä–æ—Å
                const callbackName = 'jsonp_callback_' + Date.now();
                params.append('callback', callbackName);
                
                const url = `${GAS_URL}?${params.toString()}`;
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', url);
                
                window[callbackName] = function(data) {
                    console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', data);
                    delete window[callbackName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                    clearTimeout(timeoutId);
                    
                    hideLoading(progressInterval);
                    buttons.forEach(b => b.disabled = false);
                    
                    if (data.status === 'no_data') {
                        showManagerMessage(data.message);
                    } else if (data.status === 'success') {
                        data.reportType = type;
                        data.fullInfo = fullInfo;
                        showResults(data);
                    } else {
                        showError(data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                    }
                    
                    if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.show();
                };
                
                const script = document.createElement('script');
                script.src = url;
                
                script.onerror = function() {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞');
                    delete window[callbackName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                    clearTimeout(timeoutId);
                    
                    hideLoading(progressInterval);
                    buttons.forEach(b => b.disabled = false);
                    showError('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                };
                
                const timeoutId = setTimeout(() => {
                    if (window[callbackName]) {
                        console.error('‚è∞ –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞');
                        delete window[callbackName];
                        if (script.parentNode) script.parentNode.removeChild(script);
                        
                        hideLoading(progressInterval);
                        buttons.forEach(b => b.disabled = false);
                        showError('‚è∞ –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    }
                }, 15000);
                
                document.head.appendChild(script);
            }, 500);
        }

        // Results display
        function showResults(resp) {
            const error = document.getElementById('error'), results = document.getElementById('results');
            const tbody = document.getElementById('tableBody'), tableHeader = document.getElementById('tableHeader');
            tbody.innerHTML = ''; tableHeader.innerHTML = ''; error.textContent = ''; error.innerHTML = '';
            
            if(!resp || resp.status !== 'success' || !resp.data || !resp.data.length) {
                if (resp?.status === 'no_data') showManagerMessage(resp.message);
                else showError('üîç –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                results.style.display = 'none';
                return;
            }
            
            const reportType = resp.reportType || currentSection, fullInfo = resp.fullInfo || false;
            let headers = [], totalColumn = '', totalPiecesColumn = '';
            
            switch(reportType) {
                case 'picks': 
                    headers = ['–î–∞—Ç–∞ —Å–ª–æ—Ç–∞','ID','–§–ò–û','–ê–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è','–ö–≠–§','–ò—Ç–æ–≥–æ','–ò—Ç–æ–≥–æ —à—Ç—É–∫','–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã']; 
                    totalColumn = 'total'; totalPiecesColumn = 'totalPieces'; 
                    break;
                case 'hours': 
                    headers = ['–î–∞—Ç–∞ —Å–ª–æ—Ç–∞','ID','–§–ò–û','–£—Ä–æ–≤–µ–Ω—å','–ß–∞—Å—ã','–ë–æ–Ω—É—Å','–ò—Ç–æ–≥–æ','–í–∏–¥ –æ–ø–ª–∞—Ç—ã','–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã']; 
                    totalColumn = 'total'; 
                    break;
                case 'rds': 
                    if (fullInfo) headers = ['–î–∞—Ç–∞ —Å–ª–æ—Ç–∞','ID','–§–ò–û','–£—Ä–æ–≤–µ–Ω—å','–ß–∞—Å—ã','–§–∞–∫—Ç','–ü–ª–∞–Ω','–ö–≠–§','–ë–æ–Ω—É—Å','–ò—Ç–æ–≥–æ','–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã'];
                    else headers = ['–î–∞—Ç–∞ —Å–ª–æ—Ç–∞','ID','–§–ò–û','–£—Ä–æ–≤–µ–Ω—å','–ß–∞—Å—ã','–ö–≠–§','–ë–æ–Ω—É—Å','–ò—Ç–æ–≥–æ','–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã'];
                    totalColumn = 'total'; 
                    break;
            }
            
            headers.forEach(header => { 
                const th = document.createElement('th'); 
                th.textContent = header; 
                tableHeader.appendChild(th); 
            });
            
            let total = 0, totalPieces = 0;
            
            resp.data.forEach(item => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td'); 
                    let value = '‚Äî';
                    switch(header) {
                        case '–î–∞—Ç–∞ —Å–ª–æ—Ç–∞': value = item.date || '‚Äî'; break;
                        case 'ID': value = item.id || '‚Äî'; break;
                        case '–§–ò–û': value = item.fullName || '‚Äî'; break;
                        case '–ê–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è': value = item.activeTime || '‚Äî'; break;
                        case '–ö–≠–§': value = item.coef || '‚Äî'; break;
                        case '–ò—Ç–æ–≥–æ': value = item.total || '‚Äî'; break;
                        case '–ò—Ç–æ–≥–æ —à—Ç—É–∫': value = item.totalPieces || '‚Äî'; break;
                        case '–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã': value = item.paymentDate || '‚Äî'; break;
                        case '–£—Ä–æ–≤–µ–Ω—å': value = item.level || '‚Äî'; break;
                        case '–ß–∞—Å—ã': value = item.hours || '‚Äî'; break;
                        case '–ë–æ–Ω—É—Å': value = item.bonus || '‚Äî'; break;
                        case '–í–∏–¥ –æ–ø–ª–∞—Ç—ã': value = item.paymentType || '‚Äî'; break;
                        case '–§–∞–∫—Ç': value = item.fact || '‚Äî'; break;
                        case '–ü–ª–∞–Ω': value = item.plan || '‚Äî'; break;
                    }
                    td.textContent = value; 
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
                
                if (totalColumn && item[totalColumn]) { 
                    const numValue = parseFloat(String(item[totalColumn]).replace(',','.')); 
                    total += isNaN(numValue) ? 0 : numValue; 
                }
                if (totalPiecesColumn && item[totalPiecesColumn]) { 
                    const numValue = parseFloat(String(item[totalPiecesColumn]).replace(',','.')); 
                    totalPieces += isNaN(numValue) ? 0 : numValue; 
                }
            });
            
            const totalRow = document.createElement('tr'); 
            totalRow.className = 'total-row';
            let totalLabel = '–ò—Ç–æ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥:', totalValue = total.toFixed(2);
            
            switch(reportType) {
                case 'picks': 
                    totalLabel = `–í—Å–µ–≥–æ: ${Math.round(totalPieces)} —à—Ç. / ${total.toFixed(2)}`; 
                    totalValue = ''; 
                    break;
                case 'hours': totalLabel = '–í—Å–µ–≥–æ —á–∞—Å–æ–≤:'; break;
                case 'rds': totalLabel = '–û–±—â–∞—è —Å—É–º–º–∞:'; break;
            }
            
            if (reportType === 'picks') {
                totalRow.innerHTML = `<td colspan="${headers.length - 1}" style="text-align:right;">${totalLabel}</td><td>${totalValue}</td>`;
            } else {
                totalRow.innerHTML = `<td colspan="${headers.length - 1}" style="text-align:right;">${totalLabel}</td><td>${totalValue}</td>`;
            }
            
            tbody.appendChild(totalRow);
            results.style.display = 'block';
            setTimeout(() => results.classList.add('show'), 100);
        }

        // Search functions
        function searchRDSByDate() {
            const phone = document.getElementById('phone').value.trim(), date = document.getElementById('rdsDate').value;
            const fullInfo = document.getElementById('rdsFullInfo').checked;
            if(!phone) return showError('‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä'); 
            if(!date) return showError('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
            performSearch(phone, date, null, 'rds', fullInfo);
        }

        function searchRDSCurrentMonth() {
            const phone = document.getElementById('phone').value.trim(), fullInfo = document.getElementById('rdsFullInfo').checked;
            if(!phone) return showError('‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä');
            const m = new Date().getMonth() + 1; 
            performSearch(phone, null, String(m), 'rds', fullInfo);
        }

        function searchPicksByDay() {
            const phone = document.getElementById('phone').value.trim(), date = document.getElementById('picksDayDate').value;
            if(!phone) return showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID LO'); 
            if(!date) return showError('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å');
            performSearch(phone, date, null, 'picks', false);
        }

        function searchPicksCurrentMonth() {
            const phone = document.getElementById('phone').value.trim();
            if(!phone) return showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID LO');
            const m = new Date().getMonth() + 1; 
            performSearch(phone, null, String(m), 'picks', false);
        }

        function searchPicksByWeek() {
            const phone = document.getElementById('phone').value.trim();
            const weekValue = document.getElementById('weekSelect').value;
            if(!phone) return showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID LO');
            if(!weekValue) return showError('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é');
            const [startDate, endDate] = weekValue.split('_');
            performSearch(phone, startDate, null, 'picks', false, endDate);
        }

        function searchHoursByDate() {
            const phone = document.getElementById('phone').value.trim(), date = document.getElementById('hoursDate').value;
            if(!phone) return showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID'); 
            if(!date) return showError('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
            performSearch(phone, date, null, 'hours', false);
        }

        function searchHoursCurrentMonth() {
            const phone = document.getElementById('phone').value.trim();
            if(!phone) return showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID');
            const m = new Date().getMonth() + 1; 
            performSearch(phone, null, String(m), 'hours', false);
        }

        // Modal
        function showInstructions() { document.getElementById('instructionsModal').style.display = 'block'; }
        function closeInstructions() { document.getElementById('instructionsModal').style.display = 'none'; }
        window.onclick = e => { if(e.target === document.getElementById('instructionsModal')) closeInstructions(); };

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            initTelegramWebApp();
            if (!window.Telegram?.WebApp) loadTheme();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rdsDate').value = today;
            document.getElementById('picksDayDate').value = today;
            document.getElementById('hoursDate').value = today;
            generateWeekOptions();
        });
    </script>
</body>
</html>
