<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —à—Ç—É–∫–∏, –†–î–°</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body data-theme="light">
    <div class="container">
        <div class="header">
            <h1>‚è±Ô∏è –°–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —à—Ç—É–∫–∏, –†–î–°</h1>
            <button class="theme-toggle" onclick="toggleTheme()">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
            <button class="telegram-close" onclick="closeWebApp()" style="display:none;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        
        <p class="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞</p>

        <div class="form-group">
            <label for="phone">üì± –¢–µ–ª–µ—Ñ–æ–Ω / ID LO</label>
            <input type="text" id="phone" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 79123456789">
        </div>

        <div class="button-group">
            <button id="rdsBtn" class="active" onclick="openRDS()">üìä –†–î–°</button>
            <button id="picksBtn" onclick="openPicks()">üì¶ –®–¢–£–ö–ò</button>
            <button id="hoursBtn" onclick="openHours()">‚è∞ –ß–ê–°–´</button>
            <button onclick="showInstructions()">‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –†–î–° -->
        <div id="rdsSection" class="section active">
            <label>üìÖ –î–∞—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:</label>
            <input type="date" id="rdsDate">
            <div class="checkbox-group">
                <label><input type="checkbox" id="rdsFullInfo"> –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
            </div>
            <div class="button-group" style="margin-top:10px;">
                <button onclick="searchRDSByDate()">–ü–æ –¥–Ω—é</button>
                <button onclick="searchRDSCurrentMonth()">–ó–∞ –º–µ—Å—è—Ü</button>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –®–¢–£–ö–ò -->
        <div id="picksSection" class="section">
            <div class="button-group">
                <button onclick="showPicksDay()">–î–µ–Ω—å</button>
                <button onclick="showPicksWeek()">–ù–µ–¥–µ–ª—è</button>
                <button onclick="searchPicksCurrentMonth()">–ú–µ—Å—è—Ü</button>
            </div>
            
            <div id="picksDaySection" class="section active" style="margin-top:10px;">
                <input type="date" id="picksDayDate">
                <button onclick="searchPicksByDay()">–ü–æ –¥–Ω—é</button>
            </div>
            
            <div id="picksWeekSection" class="section" style="margin-top:10px;">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é:</label>
                <select id="weekSelect">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é --</option>
                </select>
                <button onclick="searchPicksByWeek()" style="margin-top:10px;">–ü–æ–∏—Å–∫ –∑–∞ –Ω–µ–¥–µ–ª—é</button>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –ß–ê–°–´ -->
        <div id="hoursSection" class="section">
            <label>üìÖ –î–∞—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:</label>
            <input type="date" id="hoursDate">
            <div class="button-group" style="margin-top:10px;">
                <button onclick="searchHoursByDate()">–ü–æ –¥–Ω—é</button>
                <button onclick="searchHoursCurrentMonth()">–ó–∞ –º–µ—Å—è—Ü</button>
            </div>
        </div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading" style="display:none;">
            <div class="spinner"></div>
            <div class="loading-text">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
        <div id="error"></div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="results">
            <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π -->
    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInstructions()">&times;</span>
            <h3>‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</h3>
            <ul>
                <li>–í–≤–æ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ ID LO –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ</li>
                <li><strong>–†–î–°</strong>: –ø–æ–∏—Å–∫ –ø–æ ID, —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–ª–∏ –∫—Ä–∞—Ç–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</li>
                <li><strong>–®–¢–£–ö–ò</strong>: –ø–æ–∏—Å–∫ –ø–æ ID –∏ –¥–∞—Ç–µ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –¥–Ω—è–º, –Ω–µ–¥–µ–ª—è–º –∏–ª–∏ –º–µ—Å—è—Ü–∞–º</li>
                <li><strong>–ß–ê–°–´</strong>: –ø–æ–∏—Å–∫ –ø–æ ID —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã, –±–æ–Ω—É—Å–æ–≤ –∏ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –ø–æ–∏—Å–∫–∞</li>
            </ul>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ -->
    <div id="copyNotification" class="copy-notification">‚úÖ –¢–µ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwg00zQcAcvv_ujRwkmvYEKMFKXS1_F_TloYGgLKeycPOYtfU21q1G0-tXv9pdqXZx3/exec';

        // ========== TELEGRAM WEB APP –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø ==========
        function initTelegramWebApp() {
            if (window.Telegram && Telegram.WebApp) {
                const tg = Telegram.WebApp;
                
                document.body.classList.add('telegram-mode');
                document.querySelector('.telegram-close').style.display = 'block';
                
                tg.expand();
                
                if (tg.colorScheme === 'dark') {
                    document.body.setAttribute('data-theme', 'dark');
                }
                
                const user = tg.initDataUnsafe?.user;
                if (user && user.phone_number) {
                    document.getElementById('phone').value = user.phone_number;
                }
                
                tg.BackButton.onClick(() => {
                    tg.close();
                });
                
                tg.BackButton.show();
            }
        }

        function closeWebApp() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.close();
            }
        }

        // ========== –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê ==========
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        }

        // ========== –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –¢–ï–ì–ê ==========
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopyNotification();
                }).catch(err => {
                    copyFallback(text);
                });
            } else {
                copyFallback(text);
            }
        }

        function copyFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopyNotification();
            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–≥. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + text);
            }
            
            document.body.removeChild(textArea);
        }

        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ï–ö–¶–ò–Ø–ú–ò ==========
        let currentSection = 'rds';
        let searchTimeout = null;

        function setActiveButton(buttonId) {
            document.getElementById('rdsBtn').classList.remove('active');
            document.getElementById('picksBtn').classList.remove('active');
            document.getElementById('hoursBtn').classList.remove('active');
            document.getElementById(buttonId).classList.add('active');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            setTimeout(() => {
                document.getElementById(sectionId).classList.add('active');
            }, 50);
        }

        function openRDS() {
            currentSection = 'rds';
            setActiveButton('rdsBtn');
            showSection('rdsSection');
            clearForm();
        }

        function openPicks() {
            currentSection = 'picks';
            setActiveButton('picksBtn');
            showSection('picksSection');
            showPicksDay();
            clearForm();
        }

        function openHours() {
            currentSection = 'hours';
            setActiveButton('hoursBtn');
            showSection('hoursSection');
            clearForm();
        }

        function clearForm() {
            document.getElementById('error').textContent = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('tableBody').innerHTML = '';
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –®–¢–£–ö–ê–ú–ò ==========
        function showPicksDay() {
            document.getElementById('picksDaySection').classList.add('active');
            document.getElementById('picksWeekSection').classList.remove('active');
        }

        function showPicksWeek() {
            document.getElementById('picksDaySection').classList.remove('active');
            document.getElementById('picksWeekSection').classList.add('active');
            generateWeekOptions();
        }

        function generateWeekOptions() {
            const select = document.getElementById('weekSelect');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é --</option>';
            
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() - today.getDay() + 1);
            
            for(let i = -4; i <= 1; i++) {
                const weekStart = new Date(start);
                weekStart.setDate(start.getDate() + i * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                const option = document.createElement('option');
                option.value = `${formatDate(weekStart)}_${formatDate(weekEnd)}`;
                option.textContent = `${formatDDMMYY(weekStart)} ‚Äî ${formatDDMMYY(weekEnd)}`;
                select.appendChild(option);
            }
        }

        function searchPicksByWeek() {
            const phone = document.getElementById('phone').value.trim();
            const weekValue = document.getElementById('weekSelect').value;
            
            if(!phone) {
                showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID LO');
                return;
            }
            
            if(!weekValue) {
                showError('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–µ–ª—é');
                return;
            }
            
            const [startDate, endDate] = weekValue.split('_');
            performSearch(phone, startDate, null, 'picks', false, endDate);
        }

        // ========== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–¢ ==========
        function formatDate(d) {
            return d.toISOString().split('T')[0];
        }

        function formatDDMMYY(d) {
            return String(d.getDate()).padStart(2,'0')+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+String(d.getFullYear()).slice(-2);
        }

        // ========== –ê–ù–ò–ú–ò–†–û–í–ê–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê ==========
        function showLoading() {
            const loading = document.getElementById('loading');
            const progress = document.querySelector('.progress');
            
            loading.style.display = 'block';
            document.querySelector('.loading-text').style.display = 'block';
            document.querySelector('.spinner').style.display = 'block';
            document.querySelector('.progress-bar').style.display = 'block';
            
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 90) {
                    clearInterval(interval);
                } else {
                    width += Math.random() * 10;
                    progress.style.width = Math.min(width, 90) + '%';
                }
            }, 200);
            
            return interval;
        }

        function hideLoading(interval) {
            clearInterval(interval);
            
            const progress = document.querySelector('.progress');
            progress.style.width = '100%';
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.loading-text').style.display = 'none';
                document.querySelector('.spinner').style.display = 'none';
                document.querySelector('.progress-bar').style.display = 'none';
                progress.style.width = '0%';
            }, 500);
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // ========== –ü–û–ö–ê–ó –°–û–û–ë–©–ï–ù–ò–Ø –° –ú–ï–ù–ï–î–ñ–ï–†–û–ú ==========
        function showManagerMessage(message) {
            const error = document.getElementById('error');
            
            const lines = message.split('\n');
            let htmlMessage = '';
            
            lines.forEach(line => {
                if (line.includes('@')) {
                    const telegramMatch = line.match(/(@[\w_]+)/);
                    if (telegramMatch) {
                        const telegramTag = telegramMatch[1];
                        htmlMessage += line.replace(telegramTag, 
                            `<span class="telegram-tag" onclick="copyToClipboard('${telegramTag}')" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                                ${telegramTag} üìã
                            </span>`);
                    } else {
                        htmlMessage += line;
                    }
                } else {
                    htmlMessage += line;
                }
                htmlMessage += '<br>';
            });
            
            error.innerHTML = htmlMessage;
            error.style.display = 'block';
        }

        // ========== DEBOUNCE –ü–û–ò–°–ö ==========
        document.getElementById('phone').addEventListener('input', function() {
            clearTimeout(searchTimeout);
        });

        // ========== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–ò–°–ö–ê ==========
        function performSearch(phone, date, month, type, fullInfo, endDate = null) {
            if(!phone) {
                showError('‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä/ID');
                return;
            }
            
            hideError();
            const buttons = document.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);
            
            const progressInterval = showLoading();
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                const params = new URLSearchParams();
                params.append('phone', phone);
                if (date) params.append('date', date);
                if (month) params.append('month', month);
                params.append('type', type);
                params.append('fullInfo', fullInfo);
                if (endDate) params.append('endDate', endDate);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º CORS proxy –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
                const proxyUrl = `https://corsproxy.io/?${GAS_URL}?${params.toString()}`;
                
                fetch(proxyUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(resp => {
                        hideLoading(progressInterval);
                        buttons.forEach(b => b.disabled = false);
                        
                        if (resp.status === 'no_data') {
                            showManagerMessage(resp.message);
                        } else if (resp.status === 'success') {
                            resp.reportType = type;
                            resp.fullInfo = fullInfo;
                            showResults(resp);
                        } else {
                            showError(resp.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                        }
                        
                        if (window.Telegram && Telegram.WebApp) {
                            Telegram.WebApp.BackButton.show();
                        }
                    })
                    .catch(err => {
                        hideLoading(progressInterval);
                        buttons.forEach(b => b.disabled = false);
                        console.error('Fetch error:', err);
                        showError('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                    });
            }, 500);
        }

        // ========== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ==========
        function showResults(resp) {
            const error = document.getElementById('error');
            const results = document.getElementById('results');
            const tbody = document.getElementById('tableBody');
            const tableHeader = document.getElementById('tableHeader');
            
            tbody.innerHTML = '';
            tableHeader.innerHTML = '';
            error.textContent = '';
            error.innerHTML = '';
            
            if(!resp || resp.status !== 'success' || !resp.data || !resp.data.length) {
                if (resp && resp.status === 'no_data') {
                    showManagerMessage(resp.message);
                } else {
                    showError('üîç –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
                results.style.display = 'none';
                return;
            }

            const reportType = resp.reportType || currentSection;
            const fullInfo = resp.fullInfo || false;

            let headers = [];
            let totalColumn = '';
            let totalPiecesColumn = '';

            switch(reportType) {
                case 'picks':
                    headers = ['–î–∞—Ç–∞ —Å–ª–æ—Ç–∞', 'ID', '–§–ò–û', '–ê–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è', '–ö–≠–§', '–ò—Ç–æ–≥–æ', '–ò—Ç–æ–≥–æ —à—Ç—É–∫', '–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã'];
                    totalColumn = 'total';
                    totalPiecesColumn = 'totalPieces';
                    break;
                    
                case 'hours':
                    headers = ['–î–∞—Ç–∞ —Å–ª–æ—Ç–∞', 'ID', '–§–ò–û', '–£—Ä–æ–≤–µ–Ω—å', '–ß–∞—Å—ã', '–ë–æ–Ω—É—Å', '–ò—Ç–æ–≥–æ', '–í–∏–¥ –æ–ø–ª–∞—Ç—ã', '–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã'];
                    totalColumn = 'total';
                    break;
                    
                case 'rds':
                    if (fullInfo) {
                        headers = ['–î–∞—Ç–∞ —Å–ª–æ—Ç–∞', 'ID', '–§–ò–û', '–£—Ä–æ–≤–µ–Ω—å', '–ß–∞—Å—ã', '–§–∞–∫—Ç', '–ü–ª–∞–Ω', '–ö–≠–§', '–ë–æ–Ω—É—Å', '–ò—Ç–æ–≥–æ', '–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã'];
                    } else {
                        headers = ['–î–∞—Ç–∞ —Å–ª–æ—Ç–∞', 'ID', '–§–ò–û', '–£—Ä–æ–≤–µ–Ω—å', '–ß–∞—Å—ã', '–ö–≠–§', '–ë–æ–Ω—É—Å', '–ò—Ç–æ–≥–æ', '–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã'];
                    }
                    totalColumn = 'total';
                    break;
            }

            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeader.appendChild(th);
            });

            let total = 0;
            let totalPieces = 0;
            
            resp.data.forEach(item => {
                const tr = document.createElement('tr');
                
                headers.forEach(header => {
                    const td = document.createElement('td');
                    let value = '‚Äî';
                    
                    switch(header) {
                        case '–î–∞—Ç–∞ —Å–ª–æ—Ç–∞': value = item.date || '‚Äî'; break;
                        case 'ID': value = item.id || '‚Äî'; break;
                        case '–§–ò–û': value = item.fullName || '‚Äî'; break;
                        case '–ê–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è': value = item.activeTime || '‚Äî'; break;
                        case '–ö–≠–§': value = item.coef || '‚Äî'; break;
                        case '–ò—Ç–æ–≥–æ': value = item.total || '‚Äî'; break;
                        case '–ò—Ç–æ–≥–æ —à—Ç—É–∫': value = item.totalPieces || '‚Äî'; break;
                        case '–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã': value = item.paymentDate || '‚Äî'; break;
                        case '–£—Ä–æ–≤–µ–Ω—å': value = item.level || '‚Äî'; break;
                        case '–ß–∞—Å—ã': value = item.hours || '‚Äî'; break;
                        case '–ë–æ–Ω—É—Å': value = item.bonus || '‚Äî'; break;
                        case '–í–∏–¥ –æ–ø–ª–∞—Ç—ã': value = item.paymentType || '‚Äî'; break;
                        case '–§–∞–∫—Ç': value = item.fact || '‚Äî'; break;
                        case '–ü–ª–∞–Ω': value = item.plan || '‚Äî'; break;
                    }
                    
                    td.textContent = value;
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
                
                if (totalColumn && item[totalColumn]) {
                    const numValue = parseFloat(String(item[totalColumn]).replace(',', '.'));
                    total += isNaN(numValue) ? 0 : numValue;
                }
                
                if (totalPiecesColumn && item[totalPiecesColumn]) {
                    const numValue = parseFloat(String(item[totalPiecesColumn]).replace(',', '.'));
                    totalPieces += isNaN(numValue) ? 0 : numValue;
                }
            });

            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            
            let totalLabel = '–ò—Ç–æ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥:';
            let totalValue = total.toFixed(2);
            
            switch(reportType) {
                case 'picks':
                    totalLabel = `–í—Å–µ–≥–æ: ${Math.round(totalPieces)} —à—Ç. / ${total.toFixed(2)}`;
                    totalValue = '';
                    break;
                case 'hours':
                    totalLabel = '–í—Å–µ–≥–æ —á–∞—Å–æ–≤:';
                    break;
                case 'rds':
                    totalLabel = '–û–±—â–∞—è —Å—É–º–º–∞:';
                    break;
            }
            
            if (reportType === 'picks') {
                totalRow.innerHTML = `
                    <td colspan="${headers.length - 1}" style="text-align:right;">${totalLabel}</td>
                    <td>${totalValue}</td>
                `;
            } else {
                totalRow.innerHTML = `
                    <td colspan="${headers.length - 1}" style="text-align:right;">${totalLabel}</td>
                    <td>${totalValue}</td>
                `;
            }
            
            tbody.appendChild(totalRow);
            
            results.style.display = 'block';
            setTimeout(() => {
                results.classList.add('show');
            }, 100);
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–î–° ==========
        function searchRDSByDate() {
            const phone = document.getElementById('phone').value.trim();
            const date = document.getElementById('rdsDate').value;
            const fullInfo = document.getElementById('rdsFullInfo').checked;
            
            if(!phone) {
                showError('‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä');
                return;
            }
            
            if(!date) {
                showError('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
                return;
            }
            
            performSearch(phone, date, null, 'rds', fullInfo);
        }

        function searchRDSCurrentMonth() {
            const phone = document.getElementById('phone').value.trim();
            const fullInfo = document.getElementById('rdsFullInfo').checked;
            
            if(!phone) {
                showError('‚ùå –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä');
                return;
            }
            
            const m = new Date().getMonth() + 1;
            performSearch(phone, null, String(m), 'rds', fullInfo);
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –®–¢–£–ö ==========
        function searchPicksByDay() {
            const phone = document.getElementById('phone').value.trim();
            const date = document.getElementById('picksDayDate').value;
            
            if(!phone) {
                showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID LO');
                return;
            }
            
            if(!date) {
                showError('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å');
                return;
            }
            
            performSearch(phone, date, null, 'picks', false);
        }

        function searchPicksCurrentMonth() {
            const phone = document.getElementById('phone').value.trim();
            
            if(!phone) {
                showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID LO');
                return;
            }
            
            const m = new Date().getMonth() + 1;
            performSearch(phone, null, String(m), 'picks', false);
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ß–ê–°–û–í ==========
        function searchHoursByDate() {
            const phone = document.getElementById('phone').value.trim();
            const date = document.getElementById('hoursDate').value;
            
            if(!phone) {
                showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID');
                return;
            }
            
            if(!date) {
                showError('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
                return;
            }
            
            performSearch(phone, date, null, 'hours', false);
        }

        function searchHoursCurrentMonth() {
            const phone = document.getElementById('phone').value.trim();
            
            if(!phone) {
                showError('‚ùå –£–∫–∞–∂–∏—Ç–µ ID');
                return;
            }
            
            const m = new Date().getMonth() + 1;
            performSearch(phone, null, String(m), 'hours', false);
        }

        // ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ==========
        function showInstructions() {
            document.getElementById('instructionsModal').style.display = 'block';
        }

        function closeInstructions() {
            document.getElementById('instructionsModal').style.display = 'none';
        }

        window.onclick = function(e) {
            if(e.target === document.getElementById('instructionsModal')) {
                closeInstructions();
            }
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', function() {
            initTelegramWebApp();
            
            if (!window.Telegram || !Telegram.WebApp) {
                loadTheme();
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rdsDate').value = today;
            document.getElementById('picksDayDate').value = today;
            document.getElementById('hoursDate').value = today;
            
            generateWeekOptions();
        });
    </script>
</body>
</html>
